import json
import os
import requests
from datetime import datetime

# ==========================================
# ‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò PUSHEET ENGINE
# ==========================================
DB_FILE = "database.json"
CLIENT_ID = "iZIs9mchV7lxYDLnu7X797ps9SInC37T" # –ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á SoundCloud
SEARCH_QUERY = "2026" # –ò—â–µ–º —Å–≤–µ–∂–∏–π –∑–≤—É–∫
LIMIT = 20 # –°–∫–æ–ª—å–∫–æ —Ç—Ä–µ–∫–æ–≤ –±—Ä–∞—Ç—å –∑–∞ —Ä–∞–∑

# –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–∞–ø–æ–∫, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
os.makedirs("releases", exist_ok=True)
os.makedirs("artists", exist_ok=True)
os.makedirs("css", exist_ok=True)

# ==========================================
# 1. –ó–ê–ì–†–£–ó–ö–ê –ò–°–¢–û–†–ò–ò (DATABASE)
# ==========================================
print("üíæ Loading Database...")
db = {"releases": {}, "artists": {}}

if os.path.exists(DB_FILE):
    try:
        with open(DB_FILE, "r", encoding='utf-8') as f:
            db = json.load(f)
    except Exception as e:
        print(f"‚ö†Ô∏è Database error (creating new): {e}")

# ==========================================
# 2. –ü–û–ò–°–ö –ù–û–í–ò–ù–û–ö (SCANNING)
# ==========================================
print(f"üîç Scanning SoundCloud for '{SEARCH_QUERY}'...")

try:
    # –ó–∞–ø—Ä–æ—Å –∫ API: –∏—â–µ–º —Ç—Ä–µ–∫–∏, —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å—É—Ç–∫–∏
    url = f"https://api-v2.soundcloud.com/search/tracks?q={SEARCH_QUERY}&client_id={CLIENT_ID}&limit={LIMIT}&filter.created_at=last_day"
    response = requests.get(url, timeout=10)
    data = response.json()
    
    new_count = 0
    
    for item in data.get('collection', []):
        # –í—ã—Ç–∞—Å–∫–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        rid = str(item['id'])
        aid = str(item['user']['id'])
        title = item['title'].replace('"', '').replace("'", "")
        artist_name = item['user']['username'].replace('"', '').replace("'", "")
        
        # –ü–æ–ª—É—á–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –ª—É—á—à–µ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞ (500x500 –≤–º–µ—Å—Ç–æ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–π)
        raw_img = item.get('artwork_url') or item['user'].get('avatar_url', '')
        image_url = raw_img.replace('large', 't500x500') if raw_img else "https://via.placeholder.com/500x500/000000/ff0000?text=NO+COVER"

        # --- –û–ë–ù–û–í–õ–Ø–ï–ú –ë–ê–ó–£ –†–ï–õ–ò–ó–û–í ---
        if rid not in db['releases']:
            new_count += 1
            db['releases'][rid] = {
                "id": rid,
                "title": title,
                "artist": artist_name,
                "artist_id": aid,
                "image": image_url,
                "url": item['permalink_url'],
                "date": datetime.now().strftime("%d.%m.%Y"), # –î–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
                "duration": item.get('duration', 0)
            }

        # --- –û–ë–ù–û–í–õ–Ø–ï–ú –ë–ê–ó–£ –ê–†–¢–ò–°–¢–û–í ---
        if aid not in db['artists']:
            # –ï—Å–ª–∏ –∞—Ä—Ç–∏—Å—Ç–∞ –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º
            avatar = (item['user'].get('avatar_url') or "").replace('large', 't500x500')
            db['artists'][aid] = {
                "id": aid,
                "name": artist_name,
                "avatar": avatar,
                "releases": [] # –°–ø–∏—Å–æ–∫ ID —Ä–µ–ª–∏–∑–æ–≤
            }
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–µ–∫ –≤ –¥–∏—Å–∫–æ–≥—Ä–∞—Ñ–∏—é –∞—Ä—Ç–∏—Å—Ç–∞, –µ—Å–ª–∏ –µ–≥–æ —Ç–∞–º –Ω–µ—Ç
        if rid not in db['artists'][aid]['releases']:
            db['artists'][aid]['releases'].append(rid)

    print(f"üî• Found {new_count} new drops!")

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –±–∞–∑—É –æ–±—Ä–∞—Ç–Ω–æ –≤ —Ñ–∞–π–ª
    with open(DB_FILE, "w", encoding='utf-8') as f:
        json.dump(db, f, indent=2, ensure_ascii=False)

except Exception as e:
    print(f"‚ùå Error fetching data: {e}")


# ==========================================
# 3. –ì–ï–ù–ï–†–ê–¢–û–† –°–ê–ô–¢–ê (BUILDER)
# ==========================================
print("üèóÔ∏è Building Pusheet Platform...")

# --- –®–∞–±–ª–æ–Ω HEAD (–®—Ä–∏—Ñ—Ç Dela Gothic One + CSS) ---
def get_html_head(page_title):
    return f"""<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{page_title} | PUSHEET</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dela+Gothic+One&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<nav>
    <a href="/" class="logo">PUSHEET</a>
</nav>
"""

# --- A. –ì–ï–ù–ï–†–ê–¶–ò–Ø –°–¢–†–ê–ù–ò–¶ –¢–†–ï–ö–û–í (Releases) ---
for rid, track in db['releases'].items():
    html = get_html_head(f"{track['artist']} - {track['title']}")
    html += f"""
    <div class="container release-page">
        <div class="cover-box">
            <img src="{track['image']}" class="main-cover" alt="Cover">
        </div>
        <div class="info-box">
            <div class="tag">FRESH DROP</div>
            <h1>{track['title']}</h1>
            <a href="/artists/{track['artist_id']}.html" class="artist-link">{track['artist']}</a>
            
            <div class="controls">
                <a href="{track['url']}" target="_blank" class="btn-main">‚ñ∂ LISTEN ON SC</a>
            </div>
            
            <div class="meta-info">
                <span>ADDED: {track['date']}</span>
            </div>
        </div>
    </div>
    </body>
    </html>
    """
    with open(f"releases/{rid}.html", "w", encoding='utf-8') as f:
        f.write(html)

# --- B. –ì–ï–ù–ï–†–ê–¶–ò–Ø –°–¢–†–ê–ù–ò–¶ –ê–†–¢–ò–°–¢–û–í (Artists) ---
for aid, artist in db['artists'].items():
    html = get_html_head(artist['name'])
    html += f"""
    <div class="artist-header">
        <img src="{artist['avatar']}" class="artist-avi">
        <h1>{artist['name']}</h1>
        <div class="tag">ARTIST</div>
    </div>
    <div class="container">
        <h2 class="section-title">RELEASES</h2>
        <div class="grid">
    """
    
    # –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º —Ä–µ–ª–∏–∑—ã –∞—Ä—Ç–∏—Å—Ç–∞ (–æ—Ç –Ω–æ–≤—ã—Ö –∫ —Å—Ç–∞—Ä—ã–º)
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ä–µ–ª–∏–∑ –≤ –±–∞–∑–µ (–Ω–∞ —Å–ª—É—á–∞–π –æ—á–∏—Å—Ç–∫–∏)
    artist_tracks = [t for t in artist['releases'] if t in db['releases']]
    
    if not artist_tracks:
        html += "<p style='color:#666'>No releases found.</p>"
    
    for rid in reversed(artist_tracks):
        track = db['releases'][rid]
        html += f"""
        <a href="/releases/{track['id']}.html" class="card">
            <img src="{track['image']}">
            <div class="card-content">
                <div class="card-title">{track['title']}</div>
                <div class="card-date">{track['date']}</div>
            </div>
        </a>
        """
    
    html += """
        </div>
    </div>
    </body>
    </html>
    """
    with open(f"artists/{aid}.html", "w", encoding='utf-8') as f:
        f.write(html)

# --- C. –ì–ï–ù–ï–†–ê–¶–ò–Ø –ì–õ–ê–í–ù–û–ô (Index) ---
html = get_html_head("HOME")
html += """
<div class="container">
    <div class="hero-banner">
        <h2>PUSHEET MUSIC DATABASE</h2>
        <p>TRACKING SOUNDCLOUD RELEASES 24/7</p>
    </div>

    <h2 class="section-title">LATEST DROPS</h2>
    <div class="grid">
"""

# –°–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ —Ä–µ–ª–∏–∑—ã: –±–µ—Ä–µ–º –∫–ª—é—á–∏, –ø–µ—Ä–µ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ —Å–≤–µ—Ä—Ö—É)
all_ids = list(db['releases'].keys())
recent_ids = all_ids[::-1][:40] # –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 40 —à—Ç—É–∫

for rid in recent_ids:
    track = db['releases'][rid]
    html += f"""
    <a href="/releases/{track['id']}.html" class="card">
        <img src="{track['image']}">
        <div class="card-content">
            <div class="card-title">{track['title']}</div>
            <div class="card-artist">{track['artist']}</div>
        </div>
    </a>
    """

html += """
    </div>
    <footer style="text-align:center; padding: 50px; color: #444; font-size: 0.8rem;">
        PUSHEET AUTOMATED ENGINE ¬© 2026
    </footer>
</div>
</body>
</html>
"""

with open("index.html", "w", encoding='utf-8') as f:
    f.write(html)

print("‚úÖ BUILD COMPLETE. Website updated.")
